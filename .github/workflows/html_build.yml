name: Compile HTML Resume and Create Release

on:
  push:
    branches: [master]
    paths:
      - 'resume.html' # Triggers on HTML change
      - 'style.css'   # Triggers on CSS change
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Puppeteer (the headless browser tool)
      - name: Install Dependencies
        run: npm install puppeteer

      # Create a small script to run the conversion
      - name: Create PDF Generation Script
        run: |
          echo "const puppeteer = require('puppeteer');
          const path = require('path');
          (async () => {
            const browser = await puppeteer.launch({ args: ['--no-sandbox'] });
            const page = await browser.newPage();
            // Point to the local HTML file
            await page.goto('file://' + path.join(__dirname, 'resume.html'), {waitUntil: 'networkidle0'});
            
            // Replicating your LaTeX \addtolength commands
            await page.pdf({ 
              path: 'Saumya_Ranjan_Resume.pdf', 
              format: 'A4', 
              printBackground: true, 
              margin: { top: '0.3in', right: '0.4in', bottom: '0.3in', left: '0.4in' } 
            });

            await browser.close();
          })();" > generate.js

      # Run the script to create the PDF
      - name: Compile PDF
        run: node generate.js

      - name: Upload PDF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-resume-pdf
          path: Saumya_Ranjan_Resume.pdf
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write

    steps:
      - name: Download compiled artifact
        uses: actions/download-artifact@v4
        with:
          name: compiled-resume-pdf
          path: .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Resume-${{ github.sha }}
          name: Resume PDF - ${{ github.ref_name }}
          body: Automated PDF generation from HTML/CSS source.
          files: Saumya_Ranjan_Resume.pdf
          draft: false
          prerelease: false
